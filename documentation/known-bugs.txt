Known Firmware Bugs
===================
Identified 2026-02-05 via code review. Organized by severity.


CRITICAL
--------

#3  FIXED -- Mutex released before interp(); next_code copied to local buffer

#7  FIXED -- Duplicate "debug" global variable removed from main.cpp

#8  FIXED -- GPS_RX_PIN was a typo (40 instead of 44). LED_PIN=40 is correct.

#30 FIXED -- Duplicate geo function definitions (ODR violation).
    latlon_to_meters(), calculate_geo(), xy_to_polar() were defined in both
    basic_extensions.h and effects.cpp. Removed duplicates from header;
    also removed unused calculate_geo().

#31 FIXED -- setLEDr/g/b had no bounds checking on LED index.
    BASIC scripts with out-of-range indices could corrupt memory.
    Added bounds guards to all three functions.

#32 FIXED -- LUT globals (pLUT, lutSize, currentLUTIndex) not cleaned up
    between BASIC programs. Added cleanup in registerhook().


HIGH
----

#9  FIXED -- FastLED separated into dedicated render task (led.cpp/led.h).
    FastLED.show() now called from exactly one place: the LED render task
    on Core 1. All other code writes to LED buffers and calls led_show()
    to set a dirty flag. The render task runs at ~30 FPS.

#10 FIXED -- SOS_effect2() rewritten as non-blocking state machine.
    All delay() calls removed; uses millis()-based state machine
    (IDLE, WAIT_OFFSET, RAMP_UP, RAMP_DOWN) that returns to loop()
    each iteration. No new FreeRTOS task needed.

#11 FIXED -- Effects now use get_org_lat()/get_org_lon() instead of
    hardcoded origin coordinates. All three effects (SOS_effect, SOS_effect2,
    CIRCLE_effect) updated.

#12 FIXED -- SCALE_() returns input instead of scaled result

#13 FIXED -- TEMP/HUM function registration broken

#14 FIXED -- RGB<->HSV conversion functions are swapped

#15 FIXED -- ACCZ_() returns Y-axis instead of Z-axis

#16 FIXED -- EVENT_SYS_TIMER logic broken

#33 FIXED -- HAS*() functions had fragile fall-through logic.
    HASORIGIN_, HASGPS_, HASGYRO_, HASACC_, HASMAG_ rewritten with
    flat guard pattern to eliminate ambiguous fall-through.

#34 FIXED -- SETLEDRGB_() missing value clamp in non-gamma path.
    Array values were passed directly to LEDs without constraining to 0-255.

#35 FIXED -- FORMAT_() strncat buffer overflow.
    Third argument didn't account for existing buffer content.
    Also added bounds check on format argument pointer to prevent
    out-of-bounds stack reads when format has more specifiers than args.

#36 FIXED -- funhook_exec_() used unbounded sprintf().
    Replaced with snprintf() to prevent stack buffer overflow.

#37 FIXED -- WAIT_() busy-waited with yield() instead of vTaskDelay().
    Replaced with proper FreeRTOS delay to avoid burning 100% CPU.


MEDIUM
------

#18 FIXED -- SOURCE_SHELL debug flag corrected in printManager.cpp

#19 FIXED -- Added volatile to cross-core GPS/sensor/sun globals

#20 FIXED -- ROTATEARRAY_() left-rotate off-by-one corrected

#21 FIXED -- WAITFOR_() int8_t type mismatch corrected

#24 FIXED -- IMU_INT_PIN was a typo (37 instead of 41). RGB2_PIN=37 is correct.

#25 FIXED -- readFile() now reads line-by-line

#26 FIXED -- check_serial() only calls init_commands() once via flag

#27 FIXED -- Date/time functions now return -1 on error instead of 1

#28 FIXED -- DAY/MONTH/YEAR/GPSALT registered in funhook_(), GPSALT_T defined

#29 FIXED -- sunSetPosition() header signature matches implementation

#38 FIXED -- extern gps_pos_valid in effects.cpp missing volatile qualifier.

#39 FIXED -- Duplicate #include "basic_wrapper.h" in main.cpp.

#40 FIXED -- I2C_FREQ comment said 400 kHz but value was 100 kHz.

#41 FIXED -- threadLoopCount[] not volatile for cross-core access.

#42 FIXED -- GPS date/time accessors read TinyGPSPlus object cross-core.
    Cached day/month/year/hour/minute/second in volatile variables,
    updated in gps_loop(). All accessors now use cached values.

#43 FIXED -- basic.h/basic_extensions.h define globals and functions in headers.
    Added BASIC_WRAPPER_TU compile guard to basic.h ensuring it can only
    be included from basic_wrapper.cpp.

#44 FIXED -- main.cpp local hostname[16] shadowed unused static hostname[17].
    Removed the unused static global.

#45 FIXED -- vTaskDelay(1 / portTICK_PERIOD_MS) integer division yields 0
    if tick period > 1ms. Replaced all instances with pdMS_TO_TICKS()
    across main.cpp, basic.h, basic_wrapper.cpp, and led.cpp.

#46 FIXED -- Effects used Serial.print()/OutputStream directly, bypassing
    printManager mutex. Replaced with printfnl(SOURCE_OTHER, ...) calls
    in all three effects. Removed extern OutputStream from effects.cpp.

#47 FIXED -- sensors.cpp IMU structs (gValue, gyr, angle) not safe for
    cross-core reads. Cached acceleration values in volatile floats,
    updated in sensors_loop(). Accessors now use cached volatile copies.


LOW
---

#48 FIXED -- GPS get_speed()/get_dir() already use volatile globals
    (gps_speed, gps_dir). No change needed; confirmed correct.

#49 FIXED -- LittleFS mount failure not tracked.
    Added bool littlefs_mounted flag set on successful mount.
    Guarded startup.bas check and http FS page with flag.

#50 FIXED -- params[] array shared between BASIC task and main loop
    without volatile qualifier. Added volatile to declaration.

#51 FIXED -- Typos in identifiers and comments.
    IMU_avaliable -> IMU_available, imuAvaialble -> imuAvailable,
    "initalized" -> "initialized", "Calulate" -> "Calculate".
    Fixed across sensors.cpp, sensors.h, basic_wrapper.cpp,
    main.cpp, effects.cpp, basic_extensions.h.

#52 FIXED -- sensors_loop() read MPU6500 even when IMU init failed.
    Guarded accelerometer/gyro reads with IMU_available check.

#53 FIXED -- bat_voltage()/solar_voltage() returned half value on
    first call due to static last_val initialized to 0.
    Changed to -1 sentinel; first call now returns actual reading.

#54 FIXED -- getMaxAccXYZ() only tracked positive acceleration.
    Changed comparisons to use fabs() so negative values are
    correctly tracked by magnitude.
